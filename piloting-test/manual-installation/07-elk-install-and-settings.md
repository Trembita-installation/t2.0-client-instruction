# –Ü–Ω—Å—Ç–∞–ª—è—Ü—ñ—è —Å–µ—Ä–≤–µ—Ä—É –∞–Ω–∞–ª—ñ–∑—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π ELK

## üîπ –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è ELK: –û–ø–µ—Ä–∞—Ü—ñ–π–Ω–∏–π –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥

–®–ë–û —Å—Ç–≤–æ—Ä—é—î –∑–∞–ø–∏—Å –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É —â–æ–¥–æ –æ–±–º—ñ–Ω—É –¥–∞–Ω–∏–º–∏ –º—ñ–∂ –®–ë–û. –¶—ñ –∑–∞–ø–∏—Å–∏ –∫–µ—à—É—é—Ç—å—Å—è –≤ –±—É—Ñ–µ—Ä—ñ –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É (—Ä–æ–∑–º—ñ—â–µ–Ω–æ–º—É –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ñ–π –ø–∞–º‚Äô—è—Ç—ñ) —ñ –ø–æ—Ç—ñ–º –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è —á–µ—Ä–µ–∑ –∞–≥–µ–Ω—Ç –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É (PMA) –¥–ª—è –Ω–∞–∫–æ–ø–∏—á–µ–Ω–Ω—è —É –±–∞–∑—ñ –¥–∞–Ω–∏—Ö. –£—Å–ø—ñ—à–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω—ñ –∑–∞–ø–∏—Å–∏ –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è –∑ –±—É—Ñ–µ—Ä—É –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É.

–î–ª—è –∞–Ω–∞–ª—ñ–∑—É —Ç–∞ –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–∏—Ö –¥–∞–Ω–∏—Ö, –ø–µ—Ä–µ–¥–∞–π—Ç–µ —ó—Ö –∑ PMA –¥–æ Elasticsearch. –í–∏ –º–æ–∂–µ—Ç–µ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –Ω–æ–≤–∏–π —Å–µ—Ä–≤–µ—Ä Elasticsearch/Kibana –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –Ω–∞—è–≤–Ω–∏–π. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ –π–æ–≥–æ –∫–æ—Ä–µ–∫—Ç–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∑ PMA.

---

## üîß –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

### üîê –ü–æ—Ä—Ç–∏ –¥–æ—Å—Ç—É–ø—É –¥–ª—è –≤—Ö—ñ–¥–Ω–∏—Ö –∑‚Äô—î–¥–Ω–∞–Ω—å ELK

| –ü–æ—Ä—Ç (TCP) | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è | –û–±–ª–∞—Å—Ç—å –º–µ—Ä–µ–∂—ñ |
| ---------- | ----------- | -------------- |
| 5601       | –≤–µ–±—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å Kibana | –ü–†–ò–í–ê–¢–ù–ê |
| 9200       | –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ PMA –¥–æ Elasticsearch (REST API). –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞–±–æ —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ–≥–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –®–ë–û | –ü–†–ò–í–ê–¢–ù–ê |

---

## üîπ –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞

1. –ó–∞–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ –≤—Å—ñ –∞–∫—Ç–∏–≤–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó:

```bash
sudo sed -i 's/^[A-Za-z0-9]/#&/' /etc/apt/sources.list
```
2. –î–æ–¥–∞–π—Ç–µ GPG-–∫–ª—é—á –¥–ª—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é:

```bash
wget -O - https://project-repo.trembita.gov.ua:8081/public-keys/public.key.txt | sudo apt-key add -
```
3. –î–æ–¥–∞–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π:

```bash
echo 'deb https://project-repo.trembita.gov.ua:8081/repository/t2-stack-1.22.7/ jammy main' | sudo tee -a /etc/apt/sources.list
```
4. –û–Ω–æ–≤—ñ—Ç—å —Å–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç—ñ–≤:

```bash
sudo apt update
```
---

## üîπ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è ELK

1. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –ø–∞–∫–µ—Ç –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É UXP (–≤—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç–∏ Elasticsearch, Kibana —Ç–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ —Ñ–∞–π–ª–∏):

```bash
sudo apt install uxp-monitor-analytics
```

2. –ó–±–µ—Ä–µ–∂—ñ—Ç—å –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –ø–∞—Ä–æ–ª—å –Ω–∞ –µ—Ç–∞–ø—ñ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:

```bash
--------------------------- Security autoconfiguration information ------------------------------

Authentication and authorization are enabled.
TLS for the transport and HTTP layers is enabled and configured.

The generated password for the elastic built-in superuser is : ******************
```

3. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π —Ñ–∞–π–ª Elasticsearch ```/etc/elasticsearch/elasticsearch.yml``` –º—ñ—Å—Ç–∏—Ç—å —Ç–∞–∫—ñ –∑–∞–ø–∏—Å–∏, –¥–æ–¥–∞–Ω—ñ –ø–∞–∫–µ—Ç–æ–º ```uxp-monitor-analytics```:

```bash
cluster.name: uxp
node.name: ${HOSTNAME}
network.host: 0.0.0.0
search.max_buckets: 20000
```

4. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ, —Å–µ—Ä–≤–µ—Ä Kibana –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –Ω–∞ –∞–¥—Ä–µ—Å—É ```localhost```, —â–æ –æ–∑–Ω–∞—á–∞—î –Ω–µ–º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –Ω—å–æ–≥–æ –≤—ñ–¥–¥–∞–ª–µ–Ω–∏—Ö –º–∞—à–∏–Ω. –©–æ–± –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –ø—ñ–¥‚Äô—î–¥–Ω–∞–Ω–Ω—è –≤—ñ–¥ –≤—ñ–¥–¥–∞–ª–µ–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, —Å–∫–æ—Ä–∏–≥—É–π—Ç–µ —Ñ–∞–π–ª ```/etc/kibana/kibana.yml```.

```bash
sudo nano /etc/kibana/kibana.yml
```

–†–æ–∑–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä ```server.host``` —ñ –∑–º—ñ–Ω—ñ—Ç—å –π–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ ```localhost``` –Ω–∞ –Ω–µ-–∑–∞—Ü–∏–∫–ª–µ–Ω—É IP –∞–¥—Ä–µ—Å—É:

```bash
server.host: 0.0.0.0
```

5. –ü—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–º—ñ–Ω –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤—ñ—Å–∏:

```bash
sudo systemctl restart elasticsearch kibana
```

6. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å Kibana –¥–æ—Å—Ç—É–ø–Ω–∏–π —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä –∑–∞ –∞–¥—Ä–µ—Å–æ—é:

```bash
https://\<server-address\>:5601
```

8. –ó–≥–µ–Ω–µ—Ä—É–π—Ç–µ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ–π–Ω–∏–π —Ç–æ–∫–µ–Ω –¥–ª—è –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ Kibana –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ç–∞–∫–æ—ó –∫–æ–º–∞–Ω–¥–∏:

```bash
sudo /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana
```

> üîê **–ü—Ä–∏–º—ñ—Ç–∫–∞:** –¶–µ–π —Ç–æ–∫–µ–Ω –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ª–∏—à–µ –ø—Ä–∏ –ø–µ—Ä–≤–∏–Ω–Ω–æ–º—É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—ñ Kibana —ñ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è –ø–æ–¥–∞–ª—å—à–∏—Ö –≤—Ö–æ–¥—ñ–≤.


9. –£ –≤–µ–±—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ Kibana –≤—Å—Ç–∞–≤—Ç–µ —â–æ–π–Ω–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π —Ç–æ–∫–µ–Ω –∑ —Ç–µ—Ä–º—ñ–Ω–∞–ª—É —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ```Configure Elastic```.

<img src="07-elk-image/image.png" width="300"/>

10. –û—Ç—Ä–∏–º–∞–π—Ç–µ –∫–æ–¥ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó Kibana –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ç–∞–∫–æ—ó –∫–æ–º–∞–Ω–¥–∏:

```bash
sudo /usr/share/kibana/bin/kibana-verification-code
```

<img src="07-elk-image/image1.png" width="300"/>

11. –£ –≤–µ–±—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ Kibana –≤—Å—Ç–∞–≤—Ç–µ —â–æ–π–Ω–æ –æ—Ç—Ä–∏–º–∞–Ω–∏–π –∫–æ–¥ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∑ —Ç–µ—Ä–º—ñ–Ω–∞–ª—É —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ```Verify```.

12. –£ –≤–µ–±—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ Kibana –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —è–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á ```elastic```, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ä–∞–Ω—ñ—à–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –ø–∞—Ä–æ–ª—å.

> ‚ÑπÔ∏è  **–ü—Ä–∏–º—ñ—Ç–∫–∞:** –©–æ–± –∑–º—ñ–Ω–∏—Ç–∏ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤–±—É–¥–æ–≤–∞–Ω–æ–≥–æ —Å—É–ø–µ—Ä-–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ elastic, –∑–∞–ø—É—Å—Ç—ñ—Ç—å —Ç–∞–∫—É –∫–æ–º–∞–Ω–¥—É:
>
> ```bash
> sudo /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic -i
> ```

<img src="07-elk-image/image2.png" width="500"/>

---

## üîπ –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ç—Ä–∞—Ñ—ñ–∫—É –º—ñ–∂ –≤–µ–±–±—Ä–∞—É–∑–µ—Ä–æ–º —Ç–∞ Kibana

–©–æ–± –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ HTTPS –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è –º—ñ–∂ –≤–µ–±–±—Ä–∞—É–∑–µ—Ä–æ–º —Ç–∞ Kibana, —Å–ø–µ—Ä—à—É –æ—Ç—Ä–∏–º–∞–π—Ç–µ —á–∏–Ω–Ω–∏–π TLS —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –¥–ª—è —Å–µ—Ä–≤–µ—Ä—É Kibana.

> ‚ö†Ô∏è **–ü—Ä–∏–º—ñ—Ç–∫–∞:** –í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ TLS —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –≤—ñ–¥ –∑–∞–≥–∞–ª—å–Ω–æ–≤—ñ–¥–æ–º–∏—Ö —Ü–µ–Ω—Ç—Ä—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó (CA), –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ –∞–±–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ CA, –∞–±–æ —Å–∞–º–æ–ø—ñ–¥–ø–∏—Å–∞–Ω—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏.

---
### ‚ö†Ô∏è –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–∞–º–æ–ø—ñ–¥–ø–∏—Å–∞–Ω–æ–≥–æ TLS —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—É

–í–∏–∫–æ–Ω–∞–π—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω—ñ –∫–æ–º–∞–Ω–¥–∏: 

```bash
sudo /usr/share/elasticsearch/bin/elasticsearch-certutil cert \
--pem --self-signed --name kibana-server --dns <server-DNS-address> \
--ip <server-IP-address> --days 3650
```

-name ‚Äî –≤–∏–∑–Ω–∞—á–∞—î –Ω–∞–∑–≤—É –∑–∞–ø–∏—Ç—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—É, —è–∫–∏–π –±—É–¥–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ
-dns —Ç–∞ --ip –¥–æ–¥–∞—Ç–∫–æ–≤–æ –º–æ–∂—É—Ç—å –≤–∏–∑–Ω–∞—á–∏—Ç–∏, –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ, DNS –Ω–∞–∑–≤–∏ —ñ IP –∞–¥—Ä–µ—Å–∏ —É –≤–∏–≥–ª—è–¥—ñ —Ä–æ–∑–¥—ñ–ª–µ–Ω–æ–≥–æ –∫–æ–º–∞–º–∏ —Å–ø–∏—Å–∫—É, –¥–ª—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏—Ö –Ω–∞–∑–≤ —Å—É–±‚Äô—î–∫—Ç–∞ (SAN, Subject Alternative Name).

–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ, –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ —Ñ–∞–π–ª–∏ –∫–ª—é—á–∞ —ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—É (*kibana-server.key* —Ç–∞ *kibana-server.crt)* –∑–∞–ø–∞–∫–æ–≤–∞–Ω–æ —É —Ñ–∞–π–ª ```/usr/share/elasticsearch/certificate-bundle.zip```

–í–∏ –º–æ–∂–µ—Ç–µ —Ä–æ–∑–ø–∞–∫—É–≤–∞—Ç–∏ —Ü—ñ —Ñ–∞–π–ª–∏ –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É ```./kibana-server``` –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ç–∞–∫–æ—ó –∫–æ–º–∞–Ω–¥–∏:

```bash
sudo unzip /usr/share/elasticsearch/certificate-bundle.zip
```

---

1. –î–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ç—Ä–∞—Ñ—ñ–∫—É —Å–∫–æ–ø—ñ—é–π—Ç–µ –æ—Ç—Ä–∏–º–∞–Ω—ñ —Ñ–∞–π–ª–∏ TLS —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—É —ñ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞**, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, ```kibana-server.crt``` —Ç–∞ ```kibana-server.key```, —É –∫–∞—Ç–∞–ª–æ–≥ ```/etc/kibana/``` –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ Kibana.

> ‚ö†Ô∏è –Ø–∫—â–æ –≤–∏ –≥–µ–Ω–µ—Ä—É–≤–∞–ª–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ —á–µ—Ä–µ–∑ ```elasticsearch-certutil```, –ø–µ—Ä–µ–º—ñ—Å—Ç—ñ—Ç—å –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ —Ñ–∞–π–ª–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ç–∞–∫–æ—ó –∫–æ–º–∞–Ω–¥–∏:
> ```bash
> sudo mv ./kibana-server/kibana-server.* /etc/kibana/
> ```

2. –ó–∞–¥–∞–π—Ç–µ –≤–ª–∞—Å–Ω–∏–∫–∞ —Ç–∞ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É –¥–ª—è —Ñ–∞–π–ª—ñ–≤:

–ó–º—ñ–Ω—é—î–º–æ –≤–ª–∞—Å–Ω–∏–∫–∞:

```bash
sudo bash -c 'chown root:kibana /etc/kibana/kibana-server.*'
```

–ó–º—ñ–Ω—é—î–º–æ –ø—Ä–∏–≤—ñ–ª–µ—ó:

```bash
sudo bash -c 'chmod 640 /etc/kibana/kibana-server.*'
```

3. –ù–∞ —Å–µ—Ä–≤–µ—Ä—ñ Kibana, –≤—ñ–¥–∫—Ä–∏–π—Ç–µ —Ñ–∞–π–ª ```/etc/kibana/kibana.yml```

```bash
sudo nano /etc/kibana/kibana.yml
```

–î–æ–¥–∞–π—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω—ñ —Ä—è–¥–∫–∏, —â–æ–± –≤–≤—ñ–º–∫–Ω—É—Ç–∏ TLS –¥–ª—è –≤—Ö—ñ–¥–Ω–∏—Ö –∑‚Äô—î–¥–Ω–∞–Ω—å —Ç–∞ –≤–∏–∑–Ω–∞—á–∏—Ç–∏ —à–ª—è—Ö–∏ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—É —Å–µ—Ä–≤–µ—Ä—É —Ç–∞ –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ–≥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞:

```bash
server.ssl.enabled: true
server.ssl.certificate: /etc/kibana/kibana-server.crt
server.ssl.key: /etc/kibana/kibana-server.key
```

4. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ Kibana –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ç–∞–∫–æ—ó –∫–æ–º–∞–Ω–¥–∏:

```bash
sudo systemctl restart kibana
```

> ‚ÑπÔ∏è **–ü—Ä–∏–º—ñ—Ç–∫–∞:** –ü—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ü–∏—Ö –∑–º—ñ–Ω, –≤–∏ –ø–æ–≤–∏–Ω–Ω—ñ –∑–∞–≤–∂–¥–∏ –ø—ñ–¥–∫–ª—é—á–∞—Ç–∏—Å—è –¥–æ Kibana —á–µ—Ä–µ–∑ HTTPS ```https://\<server-address\>:5601```

---

## üîπ –ó‚Äô—î–¥–Ω–∞–Ω–Ω—è Elasticsearch —ñ–∑ –∞–≥–µ–Ω—Ç–æ–º –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É (PMA)

–î–ª—è –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ Elasticsearch, –∞–≥–µ–Ω—Ç PMA –ø–æ—Ç—Ä–µ–±—É—î:

- —ñ–º–µ–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –ø–∞—Ä–æ–ª—è –¥–ª—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó,
- –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏—Ö –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è —Ç–∞ –∑–∞–ø–∏—Å—É —ñ–Ω–¥–µ–∫—Å—ñ–≤ –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É.


### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ Elasticsearch –¥–ª—è PMA

1. –£ Kibana –ø–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ:
```Management``` ‚Üí ```Stack Management``` ‚Üí ```Security``` ‚Üí ```Roles``` —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—É–≤—à–∏ ```Create role```.

![](07-elk-image/image6.png)


2. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ:

- Role name: ```uxp_pma_client```
  
- Description: ```Grants privileges to UXP PMA```

- Cluster privileges: ```monitor```

- Index privileges:

   - Indices:  ```uxp-request\*```

   - Privileges: ```create_index```, ```manage```, ```read```, ```view_index_metadata```, ```write```

–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ```Create role```.

![](07-elk-image/image10.png)

3. –î–∞–ª—ñ –ø–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ:
```Management``` ‚Üí ```Stack Management``` ‚Üí ```Security``` ‚Üí ```Users``` —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ```Create user```

![](07-elk-image/image11.png)

4. –í–∫–∞–∂—ñ—Ç—å:

- Username: ```uxp_pma```

- Password: (–≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –Ω–∞–¥—ñ–π–Ω–∏–π)

- Assigned roles: ```uxp_pma_client```

–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ```Create user```.

![](07-elk-image/image12.png)

---

## üîπ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–≥–µ–Ω—Ç–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É (PMA)

1. –î–ª—è –ø–µ—Ä–µ–¥–∞—á—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–∞–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–æ–≥–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä Elasticsearch, —Å–∫–æ–ø—ñ—é–π—Ç–µ CA-—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –∑ —Å–µ—Ä–≤–µ—Ä—É Elasticsearch –Ω–∞ –®–ë–û:

```bash
scp user@elasticsearch-server:/etc/elasticsearch/certs/http_ca.crt .
```

```bash
sudo mv http_ca.crt /etc/uxp/ssl/
```

2. –ó–∞–¥–∞–π—Ç–µ –≤–ª–∞—Å–Ω–∏–∫–∞ —Ç–∞ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—É:

–ó–º—ñ–Ω—é—î–º–æ –≤–ª–∞—Å–Ω–∏–∫–∞:

```bash
sudo chown root:uxp /etc/uxp/ssl/http_ca.crt
```

–ó–º—ñ–Ω—é—î–º–æ –ø—Ä–∏–≤—ñ–ª–µ—ó:

```bash
sudo chmod 640 /etc/uxp/ssl/http_ca.crt
```

3. –ü—Ä–∏–∑—É–ø–∏–Ω—ñ—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ –ø–µ—Ä–µ–¥ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è–º:

```bash
sudo uxp-integrity pause
```

4. –í—ñ–¥—Ä–µ–¥–∞–≥—É–π—Ç–µ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π —Ñ–∞–π–ª PMA:

```bash
sudo nano /etc/uxp/monitor-agent.ini
```

–î–æ–¥–∞–π—Ç–µ —Å–µ–∫—Ü—ñ—é:

```bash
[elasticsearch]
address = <elasticsearch-ip>
port = 9200
scheme = https
ca-cert-file = /etc/uxp/ssl/http_ca.crt
username = uxp_pma
password = <your-password>
index = uxp-request
```

üî∏ –ü–æ—è—Å–Ω–µ–Ω–Ω—è –∫–ª—é—á–æ–≤–∏—Ö –ø–æ–ª—ñ–≤:

| –ü–æ–ª–µ |	–û–ø–∏—Å |
| ---- | ---- |
| address | IP –∞–±–æ DNS —Å–µ—Ä–≤–µ—Ä—É Elasticsearch |
| port | –ü–æ—Ä—Ç, –∑–∞–∑–≤–∏—á–∞–π 9200 |
| scheme	| –ü—Ä–æ—Ç–æ–∫–æ–ª –∑'—î–¥–Ω–∞–Ω–Ω—è: https |
| ca-cert-file |	–ü–æ–≤–Ω–∏–π —à–ª—è—Ö –¥–æ CA-—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ |
| username |	–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á Elasticsearch (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ uxp_pma) |
| password	| –ü–∞—Ä–æ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ Elasticsearch |
| index	| –ù–∞–∑–≤–∞ –∞–±–æ —à–∞–±–ª–æ–Ω —ñ–Ω–¥–µ–∫—Å—É, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ uxp-request, uxp-%{yyyy.MM} | 

5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å –∞–≥–µ–Ω—Ç–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É:

```bash
sudo reload-monitor-agent
```

6. –û–Ω–æ–≤—ñ—Ç—å —Ö–µ—à—ñ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ:

```bash
sudo uxp-integrity update
```

> ‚ÑπÔ∏è **–ü—Ä–∏–º—ñ—Ç–∫–∞:** –ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –∞–≥–µ–Ω—Ç PMA –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç—å —ñ–Ω–¥–µ–∫—Å uxp-request* —É Elasticsearch –ø—Ä–∏ –ø–µ—Ä—à—ñ–π –ø–µ—Ä–µ–¥–∞—á—ñ –¥–∞–Ω–∏—Ö.

> ‚ÑπÔ∏è **–ü—Ä–∏–º—ñ—Ç–∫–∞:** –ê–≥–µ–Ω—Ç –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Å–≤—ñ–π —Å–∞–º–æ–ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π TLS —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç /etc/uxp/ssl/elasticsearch.crt –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è —ñ–∑ —Å–µ—Ä–≤–µ—Ä–æ–º Elasticsearch.

---

## üîπ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Kibana

–°—Ç–≤–æ—Ä–µ–Ω–Ω—è Data View (–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö)

![](07-elk-image/image14.png)

> ‚ÑπÔ∏è **–ü—Ä–∏–º—ñ—Ç–∫–∞:** –ü—Ä–∏–º—ñ—Ç–∫–∞: –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö (Data View) –¥–æ–∑–≤–æ–ª—è—î Kibana –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏ –∑–∞–ø–∏—Å–∏ –∑ Elasticsearch. –í–∏ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –¥–ª—è –æ–¥–Ω–æ–≥–æ —ñ–Ω–¥–µ–∫—Å—É, –¥–µ–∫—ñ–ª—å–∫–æ—Ö –∞–±–æ –≤—Å—ñ—Ö —ñ–Ω–¥–µ–∫—Å—ñ–≤ —ñ–∑ –¥–∞–Ω–∏–º–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É.

> ‚ö†Ô∏è –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –º–æ–∂–Ω–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ª–∏—à–µ –¥–ª—è —ñ–Ω–¥–µ–∫—Å—É, —è–∫–∏–π –≤–∂–µ —ñ—Å–Ω—É—î –≤ Elasticsearch.


1. –ü–µ—Ä–µ–π–¥—ñ—Ç—å —É:
```Management``` ‚Üí ```Stack Management``` ‚Üí ```Kibana``` ‚Üí ```Data Views```
—Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ```Create data view```.

![](07-elk-image/image13.png)

2. –í–≤–µ–¥—ñ—Ç—å:

- Name: ```uxp-request```

- Index pattern: ```uxp-request*```

- Timestamp field: ```request_in_ts```

3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ```Save data view to Kibana```.

![](07-elk-image/image15.png)

üî∏ –ó–∞ –ø–æ—Ç—Ä–µ–±–∏, —É –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è—Ö –∑–∞—Å—Ç–æ—Å–æ–≤—É–π—Ç–µ —Ñ—ñ–ª—å—Ç—Ä, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥—É–±–ª—é–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Å—ñ–≤ –∑ –±–æ–∫—É –∫–ª—ñ—î–Ω—Ç–∞ –π —Å–µ—Ä–≤—ñ—Å—É:

```bash
security_server_type: Client
```

---

## üîπ –Ü–º–ø–æ—Ä—Ç —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–æ—ó –ø–∞–Ω–µ–ª—ñ

> ‚ÑπÔ∏è **–ü—Ä–∏–º—ñ—Ç–∫–∞:** –¶—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∞ –ø–∞–Ω–µ–ª—å –º—ñ—Å—Ç–∏—Ç—å –Ω–∞–±—ñ—Ä —Ä—ñ–∑–Ω–∏—Ö –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ–π (—Ç–µ–ø–ª–æ–≤–∞ –∫–∞—Ä—Ç–∞, –≥—Ä–∞—Ñ—ñ–∫–∏, —á–∏—Å–ª–æ–≤–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è, —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ —Ç–æ—â–æ).

–ü–∞–∫–µ—Ç ```uxp-monitor-analytics``` –º—ñ—Å—Ç–∏—Ç—å –ø—Ä–∏–∫–ª–∞–¥ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–æ—ó –ø–∞–Ω–µ–ª—ñ:

```bash
uxp-dashboard.ndjson (\[UXP\] Overview)
```

–§–∞–π–ª –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –∑–∞ —à–ª—è—Ö–æ–º:

```bash
/usr/share/doc/uxp-monitor-analytics/examples/kibana-8.x/dashboards/
```

1. –°–∫–æ–ø—ñ—é–π—Ç–µ —Ñ–∞–π–ª ```uxp-dashboard.ndjson``` –∑ —Å–µ—Ä–≤–µ—Ä–∞ Kibana –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∏–π –∫–æ–º–ø‚Äô—é—Ç–µ—Ä, –∑ —è–∫–æ–≥–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –≤–µ–±—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å Kibana.

![](07-elk-image/image16.png)

2. –£ Kibana –ø–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ ```Management``` ‚Üí ```Stack Management``` ‚Üí ```Kibana``` ‚Üí ```Saved Objects``` —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ```Import```.

![](07-elk-image/image17.png)

3. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–∞–π–ª ```uxp-dashboard.ndjson```

4. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ```Import```, –∞ –ø–æ—Ç—ñ–º ```Done```

‚úÖ –ì–æ—Ç–æ–≤–æ. –ü–∞–Ω–µ–ª—å –∑‚Äô—è–≤–∏—Ç—å—Å—è –≤ —Ä–æ–∑–¥—ñ–ª—ñ ```Analytics``` ‚Üí ```Dashboard```.
